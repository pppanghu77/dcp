#!/bin/bash

# SSH Key Setup Script
# å¿«é€Ÿä¸ºè¿œç¨‹ä¸»æœºè®¾ç½®SSHå¯†é’¥è®¤è¯ï¼Œå®žçŽ°å…å¯†ç™»å½•

# ç‰ˆæœ¬ä¿¡æ¯
VERSION="1.0.0"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# é…ç½®
SSH_KEY_DIR="$HOME/.ssh"
DEFAULT_KEY_NAME="id_rsa"
DEFAULT_KEY_TYPE="rsa"
DEFAULT_KEY_BITS="4096"

# æ‰“å°å¸®åŠ©ä¿¡æ¯
usage() {
    echo -e "${BLUE}SSH Key Setup Script v${VERSION}${NC}"
    echo "å¿«é€Ÿä¸ºè¿œç¨‹ä¸»æœºè®¾ç½®SSHå¯†é’¥è®¤è¯ï¼Œå®žçŽ°å…å¯†ç™»å½•"
    echo
    echo "Usage:"
    echo "  $0 [options] user@hostname"
    echo
    echo "Options:"
    echo "  -h, --help           æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo "  -k, --key FILE       ä½¿ç”¨æŒ‡å®šçš„SSHå¯†é’¥æ–‡ä»¶ (é»˜è®¤: ~/.ssh/id_rsa)"
    echo "  -t, --type TYPE      å¯†é’¥ç±»åž‹ (rsa|ed25519|ecdsa, é»˜è®¤: rsa)"
    echo "  -b, --bits BITS      RSAå¯†é’¥é•¿åº¦ (é»˜è®¤: 4096)"
    echo "  -p, --port PORT      SSHç«¯å£ (é»˜è®¤: 22)"
    echo "  -f, --force          å¼ºåˆ¶è¦†ç›–çŽ°æœ‰å¯†é’¥"
    echo "  --test               ä»…æµ‹è¯•SSHè¿žæŽ¥"
    echo "  --list-keys          åˆ—å‡ºæœ¬åœ°SSHå¯†é’¥"
    echo "  --generate-only      ä»…ç”Ÿæˆå¯†é’¥ï¼Œä¸ä¸Šä¼ "
    echo
    echo "Examples:"
    echo "  $0 user@192.168.1.100"
    echo "  $0 -k ~/.ssh/mykey user@server.com"
    echo "  $0 -t ed25519 user@host.local"
    echo "  $0 -p 2222 user@custom-port-host"
    echo "  $0 --test user@host   # æµ‹è¯•è¿žæŽ¥"
    echo
    echo "Features:"
    echo "  âœ“ è‡ªåŠ¨ç”ŸæˆSSHå¯†é’¥å¯¹"
    echo "  âœ“ è‡ªåŠ¨ä¸Šä¼ å…¬é’¥åˆ°è¿œç¨‹ä¸»æœº"
    echo "  âœ“ æ”¯æŒå¤šç§å¯†é’¥ç±»åž‹"
    echo "  âœ“ è‡ªåŠ¨æµ‹è¯•è¿žæŽ¥"
    echo "  âœ“ æ”¯æŒè‡ªå®šä¹‰ç«¯å£"
    echo
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    local missing_deps=()

    if ! command -v ssh >/dev/null 2>&1; then
        missing_deps+=("ssh")
    fi

    if ! command -v ssh-keygen >/dev/null 2>&1; then
        missing_deps+=("ssh-keygen")
    fi

    if ! command -v ssh-copy-id >/dev/null 2>&1; then
        missing_deps+=("ssh-copy-id")
    fi

    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        echo -e "${RED}é”™è¯¯: ç¼ºå°‘å¿…è¦çš„ä¾èµ–:${NC}"
        printf '  %s\n' "${missing_deps[@]}"
        echo
        echo "è¯·å®‰è£… openssh-client åŒ…:"
        echo "  Ubuntu/Debian: sudo apt install openssh-client"
        echo "  CentOS/RHEL:   sudo yum install openssh-clients"
        echo "  Arch Linux:    sudo pacman -S openssh"
        exit 1
    fi
}

# è§£æžä¸»æœºä¿¡æ¯
parse_host() {
    local input="$1"

    if [[ ! "$input" =~ ^[^@]+@[^@]+$ ]]; then
        echo -e "${RED}é”™è¯¯: ä¸»æœºæ ¼å¼å¿…é¡»ä¸º user@hostname${NC}"
        exit 1
    fi

    USER="${input%%@*}"
    HOST="${input##*@}"

    # æ£€æŸ¥æ˜¯å¦åŒ…å«ç«¯å£
    if [[ "$HOST" =~ ^(.+):([0-9]+)$ ]]; then
        HOST="${BASH_REMATCH[1]}"
        PORT="${BASH_REMATCH[2]}"
    fi

    echo -e "${BLUE}ç›®æ ‡ä¸»æœºä¿¡æ¯:${NC}"
    echo "  ç”¨æˆ·: $USER"
    echo "  ä¸»æœº: $HOST"
    echo "  ç«¯å£: $PORT"
    echo
}

# ç”ŸæˆSSHå¯†é’¥
generate_ssh_key() {
    local key_file="$1"
    local key_type="$2"
    local key_bits="$3"
    local force="$4"

    # æ£€æŸ¥å¯†é’¥æ˜¯å¦å·²å­˜åœ¨
    if [[ -f "$key_file" && "$force" != "true" ]]; then
        echo -e "${YELLOW}SSHå¯†é’¥å·²å­˜åœ¨: ${NC}$key_file"
        read -p "æ˜¯å¦ä½¿ç”¨çŽ°æœ‰å¯†é’¥? [Y/n]: " -r response
        if [[ "$response" =~ ^[Nn]$ ]]; then
            read -p "æ˜¯å¦è¦†ç›–çŽ°æœ‰å¯†é’¥? [y/N]: " -r response
            if [[ ! "$response" =~ ^[Yy]$ ]]; then
                echo -e "${RED}æ“ä½œå·²å–æ¶ˆ${NC}"
                exit 1
            fi
            force="true"
        else
            echo -e "${GREEN}ä½¿ç”¨çŽ°æœ‰å¯†é’¥: ${NC}$key_file"
            return 0
        fi
    fi

    # ç¡®ä¿ .ssh ç›®å½•å­˜åœ¨
    if [[ ! -d "$SSH_KEY_DIR" ]]; then
        mkdir -p "$SSH_KEY_DIR"
        chmod 700 "$SSH_KEY_DIR"
    fi

    echo -e "${BLUE}ç”ŸæˆSSHå¯†é’¥...${NC}"
    echo "  ç±»åž‹: $key_type"
    [[ "$key_type" == "rsa" ]] && echo "  é•¿åº¦: $key_bits bits"
    echo "  æ–‡ä»¶: $key_file"
    echo

    # ç”Ÿæˆå¯†é’¥
    local ssh_keygen_cmd="ssh-keygen -t $key_type"
    [[ "$key_type" == "rsa" ]] && ssh_keygen_cmd+=" -b $key_bits"
    ssh_keygen_cmd+=" -f '$key_file' -N '' -C '$(whoami)@$(hostname)-$(date +%Y%m%d)'"

    if eval "$ssh_keygen_cmd"; then
        chmod 600 "$key_file"
        chmod 644 "${key_file}.pub"
        echo -e "${GREEN}âœ“ SSHå¯†é’¥ç”ŸæˆæˆåŠŸ${NC}"
        echo -e "  ç§é’¥: $key_file"
        echo -e "  å…¬é’¥: ${key_file}.pub"
        echo
    else
        echo -e "${RED}âœ— SSHå¯†é’¥ç”Ÿæˆå¤±è´¥${NC}"
        exit 1
    fi
}

# æµ‹è¯•SSHè¿žæŽ¥
test_ssh_connection() {
    local user="$1"
    local host="$2"
    local port="$3"
    local key_file="$4"

    echo -e "${BLUE}æµ‹è¯•SSHè¿žæŽ¥...${NC}"

    local ssh_opts="-o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no"
    [[ -n "$key_file" ]] && ssh_opts+=" -i '$key_file'"
    [[ -n "$port" ]] && ssh_opts+=" -p $port"

    if ssh $ssh_opts "$user@$host" "echo 'SSHè¿žæŽ¥æµ‹è¯•æˆåŠŸ'" 2>/dev/null; then
        echo -e "${GREEN}âœ“ SSHè¿žæŽ¥æˆåŠŸ (å…å¯†ç™»å½•å·²é…ç½®)${NC}"
        return 0
    else
        echo -e "${YELLOW}âš  SSHè¿žæŽ¥éœ€è¦å¯†ç éªŒè¯${NC}"
        return 1
    fi
}

# ä¸Šä¼ SSHå…¬é’¥
upload_ssh_key() {
    local user="$1"
    local host="$2"
    local port="$3"
    local key_file="$4"

    local pub_key_file="${key_file}.pub"

    if [[ ! -f "$pub_key_file" ]]; then
        echo -e "${RED}é”™è¯¯: å…¬é’¥æ–‡ä»¶ä¸å­˜åœ¨: $pub_key_file${NC}"
        exit 1
    fi

    echo -e "${BLUE}ä¸Šä¼ SSHå…¬é’¥åˆ°è¿œç¨‹ä¸»æœº...${NC}"

    # æž„å»º ssh-copy-id å‘½ä»¤
    local copy_cmd="ssh-copy-id"
    [[ -n "$port" ]] && copy_cmd+=" -p $port"
    copy_cmd+=" -i '$pub_key_file' '$user@$host'"

    echo "æ‰§è¡Œå‘½ä»¤: $copy_cmd"
    echo -e "${YELLOW}è¯·è¾“å…¥è¿œç¨‹ä¸»æœºçš„å¯†ç :${NC}"

    if eval "$copy_cmd"; then
        echo -e "${GREEN}âœ“ SSHå…¬é’¥ä¸Šä¼ æˆåŠŸ${NC}"
        return 0
    else
        echo -e "${RED}âœ— SSHå…¬é’¥ä¸Šä¼ å¤±è´¥${NC}"
        return 1
    fi
}

# åˆ—å‡ºæœ¬åœ°SSHå¯†é’¥
list_ssh_keys() {
    echo -e "${BLUE}æœ¬åœ°SSHå¯†é’¥åˆ—è¡¨:${NC}"
    echo

    if [[ ! -d "$SSH_KEY_DIR" ]]; then
        echo -e "${YELLOW}SSHç›®å½•ä¸å­˜åœ¨: $SSH_KEY_DIR${NC}"
        return
    fi

    local found_keys=false

    for key_file in "$SSH_KEY_DIR"/*.pub; do
        if [[ -f "$key_file" ]]; then
            found_keys=true
            local private_key="${key_file%.pub}"
            local key_type=$(ssh-keygen -l -f "$key_file" 2>/dev/null | awk '{print $4}' | tr -d '()')
            local key_length=$(ssh-keygen -l -f "$key_file" 2>/dev/null | awk '{print $1}')
            local key_comment=$(ssh-keygen -l -f "$key_file" 2>/dev/null | awk '{for(i=3;i<=NF;i++) printf "%s ", $i; print ""}' | sed 's/[()]//g')

            echo -e "${GREEN}ç§é’¥:${NC} $private_key"
            echo -e "${GREEN}å…¬é’¥:${NC} $key_file"
            echo -e "${GREEN}ç±»åž‹:${NC} $key_type ($key_length bits)"
            echo -e "${GREEN}æ³¨é‡Š:${NC} $key_comment"
            echo
        fi
    done

    if [[ "$found_keys" == false ]]; then
        echo -e "${YELLOW}æœªæ‰¾åˆ°SSHå¯†é’¥æ–‡ä»¶${NC}"
        echo "ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆæ–°å¯†é’¥:"
        echo "  $0 --generate-only user@hostname"
    fi
}

# æ˜¾ç¤ºè¿žæŽ¥é…ç½®å»ºè®®
show_ssh_config() {
    local user="$1"
    local host="$2"
    local port="$3"
    local key_file="$4"

    echo -e "${CYAN}SSHé…ç½®å»ºè®®:${NC}"
    echo
    echo "å¯ä»¥åœ¨ ~/.ssh/config ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®:"
    echo
    echo "Host $host"
    echo "    HostName $host"
    echo "    User $user"
    [[ -n "$port" && "$port" != "22" ]] && echo "    Port $port"
    echo "    IdentityFile $key_file"
    echo "    IdentitiesOnly yes"
    echo
    echo "é…ç½®åŽå¯ä»¥ç›´æŽ¥ä½¿ç”¨: ssh $host"
    echo
}

# ä¸»å‡½æ•°
main() {
    local target_host=""
    local key_file="$SSH_KEY_DIR/$DEFAULT_KEY_NAME"
    local key_type="$DEFAULT_KEY_TYPE"
    local key_bits="$DEFAULT_KEY_BITS"
    local port="22"
    local force=false
    local test_only=false
    local list_keys=false
    local generate_only=false

    # è§£æžå‘½ä»¤è¡Œå‚æ•°
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                usage
                exit 0
                ;;
            -k|--key)
                key_file="$2"
                shift 2
                ;;
            -t|--type)
                key_type="$2"
                shift 2
                ;;
            -b|--bits)
                key_bits="$2"
                shift 2
                ;;
            -p|--port)
                port="$2"
                shift 2
                ;;
            -f|--force)
                force=true
                shift
                ;;
            --test)
                test_only=true
                shift
                ;;
            --list-keys)
                list_keys=true
                shift
                ;;
            --generate-only)
                generate_only=true
                shift
                ;;
            -*)
                echo -e "${RED}é”™è¯¯: æœªçŸ¥é€‰é¡¹ $1${NC}"
                echo "ä½¿ç”¨ $0 --help æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯"
                exit 1
                ;;
            *)
                if [[ -z "$target_host" ]]; then
                    target_host="$1"
                else
                    echo -e "${RED}é”™è¯¯: å¤šä½™çš„å‚æ•° $1${NC}"
                    exit 1
                fi
                shift
                ;;
        esac
    done

    # æ£€æŸ¥ä¾èµ–
    check_dependencies

    # åˆ—å‡ºå¯†é’¥
    if [[ "$list_keys" == true ]]; then
        list_ssh_keys
        exit 0
    fi

    # æ£€æŸ¥ç›®æ ‡ä¸»æœºå‚æ•°
    if [[ -z "$target_host" ]]; then
        echo -e "${RED}é”™è¯¯: è¯·æŒ‡å®šç›®æ ‡ä¸»æœº${NC}"
        echo "ä½¿ç”¨ $0 --help æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯"
        exit 1
    fi

    # è§£æžä¸»æœºä¿¡æ¯
    parse_host "$target_host"

    # æ‰©å±•å¯†é’¥æ–‡ä»¶è·¯å¾„
    key_file="${key_file/#\~/$HOME}"

    # ä»…æµ‹è¯•è¿žæŽ¥
    if [[ "$test_only" == true ]]; then
        test_ssh_connection "$USER" "$HOST" "$port" "$key_file"
        exit $?
    fi

    # éªŒè¯å¯†é’¥ç±»åž‹
    if [[ ! "$key_type" =~ ^(rsa|ed25519|ecdsa)$ ]]; then
        echo -e "${RED}é”™è¯¯: ä¸æ”¯æŒçš„å¯†é’¥ç±»åž‹: $key_type${NC}"
        echo "æ”¯æŒçš„ç±»åž‹: rsa, ed25519, ecdsa"
        exit 1
    fi

    # ç”Ÿæˆå¯†é’¥
    generate_ssh_key "$key_file" "$key_type" "$key_bits" "$force"

    # ä»…ç”Ÿæˆå¯†é’¥
    if [[ "$generate_only" == true ]]; then
        echo -e "${GREEN}å¯†é’¥ç”Ÿæˆå®Œæˆï¼${NC}"
        echo "è¦ä¸Šä¼ åˆ°è¿œç¨‹ä¸»æœºï¼Œè¯·è¿è¡Œ:"
        echo "  $0 $target_host -k $key_file"
        exit 0
    fi

    # æµ‹è¯•çŽ°æœ‰è¿žæŽ¥
    if test_ssh_connection "$USER" "$HOST" "$port" "$key_file"; then
        echo -e "${GREEN}SSHå…å¯†ç™»å½•å·²é…ç½®å®Œæˆï¼${NC}"
        show_ssh_config "$USER" "$HOST" "$port" "$key_file"
        exit 0
    fi

    # ä¸Šä¼ å…¬é’¥
    echo
    if upload_ssh_key "$USER" "$HOST" "$port" "$key_file"; then
        echo
        echo -e "${BLUE}éªŒè¯é…ç½®...${NC}"
        if test_ssh_connection "$USER" "$HOST" "$port" "$key_file"; then
            echo
            echo -e "${GREEN}ðŸŽ‰ SSHå…å¯†ç™»å½•é…ç½®æˆåŠŸï¼${NC}"
            show_ssh_config "$USER" "$HOST" "$port" "$key_file"
        else
            echo -e "${YELLOW}âš  é…ç½®å¯èƒ½æœªå®Œå…¨ç”Ÿæ•ˆï¼Œè¯·ç¨åŽé‡è¯•${NC}"
        fi
    else
        echo -e "${RED}SSHå¯†é’¥é…ç½®å¤±è´¥${NC}"
        exit 1
    fi
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"
